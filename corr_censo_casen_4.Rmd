---
title: Correlaciones entre variables del Censo y CASEN a nivel de Zona Censal IV
author:
- name: VE-CC-AJ
  affiliation: DataIntelligence
subtitle: | 

date: "Martes 15-06-2021"

abstract: |
  Tenemos dos objetivos. El primero, dentro de la lógica de expandir la información del nivel comunal al de las zonas (manzanas), será correlacionar variables relevantes que estén presentes en la Casen 2017 (ingresos totales promedios a nivel comunal) con variables del Censo 2017. Decidimos utilizar variables a correlacionar desde el Censo del 2017 porque su información es más exacta (no es una muestra), puede que no coincidan las categorías de respuesta en variables presentes en ambos instrumentos y la Casen del 2017 omite alrededor de 20 comunas (ésta ausencia no la podemos remediar pues la arrastraremos en el cálculo del promedio de ingresos comunales).
  
    El segundo, construir una tabla de proporciones de zonas en relación a las comunas.
    
header-includes:
   - \usepackage[]{babel}

output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
#library(ggpubr)
library(markdown)
library(shiny)
library(shinythemes)
library(tidyverse)
library(magrittr)
library(lubridate)
#library(plotly)
library(kableExtra)
library(knitr)
library("readxl")
library(writexl)
#library(RPostgreSQL)
#library(devtools)
library(remotes)
library(DBI)
library(tidyverse)
library(kableExtra)
#library(reldist)
library("readxl")
library("writexl")
library(kableExtra)
library(PerformanceAnalytics)
library("rio")
```

## 1 Variables presentes en el Censo 2017 a correlacionar con ingresos promedios comunales.

Leemos los datos del censo **personas** 2017:

```{r}
# library("rio")
# x <- import("Microdato_Censo2017-Personas.csv")
```

Construimos la clave:

```{r}
# codigos <- x$COMUNA
# 
# rango <- seq(1:nrow(x))
# 
# cadena<- paste("0",codigos[rango], sep = "")
# 
# cadena <- substr(cadena,(nchar(cadena)[rango])-(4),6)
# codigos <- as.data.frame(codigos)
# cadena <- as.data.frame(cadena)
# comuna_corr <- cbind(codigos,cadena)
# 
# codigos <- x$DC
# 
# rango <- seq(1:nrow(x))
# 
# cadena <- paste("0",codigos[rango], sep = "")
# 
# cadena <- substr(cadena,(nchar(cadena)[rango])-(1),(nchar(cadena)[rango]))
# 
# codigos <- as.data.frame(codigos)
# cadena <- as.data.frame(cadena)
# dc <- cbind(codigos,cadena)
# 
# codigos <- x$ZC_LOC
# rango <- seq(1:nrow(x))
# cadena<- paste("00",codigos[rango], sep = "")
# cadena <- substr(cadena,(nchar(cadena)[rango])-(2),nchar(cadena)[rango])
# codigos <- as.data.frame(codigos)
# cadena <- as.data.frame(cadena)
# cadena_c <- cbind(codigos,cadena)
# 
# x$clave <- paste(x$COMUNA, dc$cadena, x$AREA,  cadena_c$cadena, sep="")
# 
# saveRDS(x, "censo_personas_con_clave_17.rds")
# 
# tablamadre <- head(x,50)
# 
# kbl(tablamadre) %>%
#   kable_styling(bootstrap_options = c("striped", "hover")) %>%
#   kable_paper() %>%
#   scroll_box(width = "100%", height = "300px")
```



### 1.1 **P08**: Sexo

1 Hombre\
2 Mujer

```{r}
tabla_con_clave <- readRDS("censo_personas_con_clave_17.rds")
b <- tabla_con_clave$COMUNA
c <- tabla_con_clave$P08
cross_tab =  xtabs( ~ unlist(b) + unlist(c))
tabla <- as.data.frame(cross_tab)
d <-tabla[!(tabla$Freq == 0),]
d$anio <- "2017"
# head(d,5)

# Debemos apilar lado a lado los datos de frecuencias de sexos y agregar un cero al campo de codigo comunal.
censo_2017_hombres <- filter(d, d$unlist.c. == 1)
names(censo_2017_hombres)[3] <- "Hombres"  

censo_2017_mujeres <- filter(d, d$unlist.c. == 2)
names(censo_2017_mujeres)[3] <- "Mujeres"  

#Unimos:
df_final = merge( x = censo_2017_hombres, y = censo_2017_mujeres, by = "unlist.b.", all.x = TRUE)

# Limpiamos y renombramos columnas:

df_final <- df_final[,-c(2,5,7),drop=FALSE] 
names(df_final)[1] <- "comuna"  

# Agregamos un cero a los codigos comunales de 4 digitos:
  
# recogemos el campo Comuna:
codigos <- df_final$comuna
# construimos una secuencia llamada rango del 1 al total de filas del dataset:
rango <- seq(1:nrow(df_final))
# Creamos un string que agrega un cero a todos los registros:
cadena <- paste("0",codigos[rango], sep = "")

# El string cadena tiene o 5 o 6 digitos, los cuales siempre deben ser siempre 5 agregandole un cero al inicio de los que tienen 4.
# Para ello extraemos un substring de la cadena sobre todas las filas (rangos) comenzando desde el primero o el segundo y llegando siempre al 6.

cadena <- substr(cadena,(nchar(cadena)[rango])-(4),6)
codigos <- as.data.frame(codigos)
cadena <- as.data.frame(cadena)
comuna_corr <- cbind(df_final,cadena)

comuna_corr <- comuna_corr[,-c(1),drop=FALSE] 
names(comuna_corr)[4] <- "código" 

# Hacemos el merge con los ingresos comunales:

ingresos_expandidos_2017 <- readRDS("ingresos_expandidos_17.rds")

df_2017_2 = merge( x = comuna_corr, y = ingresos_expandidos_2017, by = "código", all.x = TRUE)

tablamadre <- head(df_2017_2,50)

kbl(tablamadre) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```

```{r}
saveRDS(df_2017_2, "h_y_m_2017_censo.rds")
```



<br>

Correlacionamos:

Hombres e Ingresos expandidos:

```{r}
dat1 <- data.frame(df_2017_2$Hombres, df_2017_2$Ingresos_expandidos)
chart.Correlation(dat1)
```

Mujeres e Ingresos expandidos:

```{r}
dat1 <- data.frame(df_2017_2$Mujeres, df_2017_2$Ingresos_expandidos)
chart.Correlation(dat1)
```

### 1.2 **P09**: Edad

(0-100)\
100 años y más

#### 1.2.1 Queremos saber la frecuencia de personas entre 40 y 49 años que viven por comuna:


```{r}
tabla_con_clave <- readRDS("censo_personas_con_clave_17.rds")
```



```{r}
b <- tabla_con_clave$COMUNA
c <- tabla_con_clave$P09
cross_tab =  xtabs( ~ unlist(b) + unlist(c))
tabla <- as.data.frame(cross_tab)
d <-tabla[!(tabla$Freq == 0),]
names(d)[1] <- "comuna"
names(d)[2] <- "edad"
d$anio <- "2017"

# Hay que construir un dataframe solo con el rango de edad entre 40 y 49 años:

d_rango <- filter(d, as.numeric(d$edad) > 40 & as.numeric(d$edad) < 51)
```

para nuestro requerimiento los rangos deben establecerse entre > 40 y < 51

```{r}
head(d_rango,10)
```
```{r}
tail(d_rango,10)
```

```{r}
# Hay que sumar todos los rangos:
d_rango_sum <- aggregate(d_rango$Freq, by=list(Category=d_rango$comuna), FUN=sum)

# Agregamos un cero al codigo comunal de cuatro cifras:

# recogemos el campo Comuna:
codigos <- d_rango_sum$Category
# construimos una secuencia llamada rango del 1 al total de filas del dataset:
rango <- seq(1:nrow(d_rango_sum))
# Creamos un string que agrega un cero a todos los registros:
cadena <- paste("0",codigos[rango], sep = "")

# El string cadena tiene o 5 o 6 digitos, los cuales siempre deben ser siempre 5 agregandole un cero al inicio de los que tienen 4.
# Para ello extraemos un substring de la cadena sobre todas las filas (rangos) comenzando desde el primero o el segundo y llegando siempre al 6.

cadena <- substr(cadena,(nchar(cadena)[rango])-(4),6)
codigos <- as.data.frame(codigos)
cadena <- as.data.frame(cadena)
comuna_corr <- cbind(d_rango_sum,cadena)

comuna_corr <- comuna_corr[,-c(1),drop=FALSE] 
names(comuna_corr)[2] <- "código"
```

Unimos con ingresos promedios expandidos:
 
```{r}
df_2017_2 = merge( x = comuna_corr, y = ingresos_expandidos_2017, by = "código", all.x = TRUE)

names(df_2017_2)[2] <- "40_49"

tablamadre <- head(df_2017_2,50)

kbl(tablamadre) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```
 
<br> 
 
Correlacionamos:

```{r}
dat1 <- data.frame(df_2017_2$`40_49`, df_2017_2$Ingresos_expandidos)
chart.Correlation(dat1)
```


#### 1.2.2 Queremos saber la frecuencia de personas entre 30 y 39 años que viven por comuna:


```{r}
b <- tabla_con_clave$COMUNA
c <- tabla_con_clave$P09
cross_tab =  xtabs( ~ unlist(b) + unlist(c))
tabla <- as.data.frame(cross_tab)
d <-tabla[!(tabla$Freq == 0),]
names(d)[1] <- "comuna"
names(d)[2] <- "edad"
d$anio <- "2017"
```


```{r}
# Hay que construir un dataframe solo con el rango de edad entre 30 y 39 años:

d_rango <- filter(d, as.numeric(d$edad) > 30 & as.numeric(d$edad) < 41)

# Hay que sumar todos los rangos:
d_rango_sum <- aggregate(d_rango$Freq, by=list(Category=d_rango$comuna), FUN=sum)

# Agregamos un cero al codigo comunal de cuatro cifras:

# recogemos el campo Comuna:
codigos <- d_rango_sum$Category
# construimos una secuencia llamada rango del 1 al total de filas del dataset:
rango <- seq(1:nrow(d_rango_sum))
# Creamos un string que agrega un cero a todos los registros:
cadena <- paste("0",codigos[rango], sep = "")

# El string cadena tiene o 5 o 6 digitos, los cuales siempre deben ser siempre 5 agregandole un cero al inicio de los que tienen 4.
# Para ello extraemos un substring de la cadena sobre todas las filas (rangos) comenzando desde el primero o el segundo y llegando siempre al 6.

cadena <- substr(cadena,(nchar(cadena)[rango])-(4),6)
codigos <- as.data.frame(codigos)
cadena <- as.data.frame(cadena)
comuna_corr <- cbind(d_rango_sum,cadena)

comuna_corr <- comuna_corr[,-c(1),drop=FALSE] 
names(comuna_corr)[2] <- "código"
```

Unimos con ingresos promedios expandidos:
 
```{r}
df_2017_2 = merge( x = comuna_corr, y = ingresos_expandidos_2017, by = "código", all.x = TRUE)

names(df_2017_2)[2] <- "30_39"

tablamadre <- head(df_2017_2,50)

kbl(tablamadre) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```
 
<br> 
 
Correlacionamos:

```{r}
dat1 <- data.frame(df_2017_2$`30_39`, df_2017_2$Ingresos_expandidos)
chart.Correlation(dat1)
```


```{r}

Censo2017_Personas <- import("Microdato_Censo2017-Personas.csv")
nrow(Censo2017_Personas)
```

```{r}

Censo2017_Viviendas <- import("Microdato_Censo2017-Viviendas.csv")
nrow(Censo2017_Viviendas)
```



## 2 Tabla de proporciones 

Leemos la tabla Casen 2017 de personas que ya tiene integrada la clave:

```{r}
tabla_con_clave <- readRDS("censo_personas_con_clave_17.rds")
```

```{r}
x <- tabla_con_clave
r3_100 <- x[c(1:100),]

kbl(r3_100) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```
<br>
Obtenemos las frecuencias de personas por manzana, por comuna:

```{r}
r3 <-table(x$COMUNA, as.numeric(x$clave))
r3 <- as.data.frame(r3)

r3 <- r3[!(r3$Freq == 0),]
r3_100 <- r3[c(1:100),]

kbl(r3_100) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```


```{r}
saveRDS(r3, "frec_man_com.rds")
frec_man_com <- readRDS("frec_man_com.rds")
```
<br>
Calculamos una columna de proporciones para la comuna 1107:

```{r}
frec_man_com_1107 <- filter(frec_man_com, frec_man_com$Var1 == 1107)
frec_man_com_1107$p <- frec_man_com_1107$Freq*100/sum(frec_man_com_1107$Freq)
```

```{r}
kbl(frec_man_com_1107) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```
<br>
Calculamos las proporciones ahora para todas las comunas:

```{r}
codigos_com <- unique(frec_man_com$Var1)
frec_man_com_parcial_total <- data.frame()

for(i in codigos_com){
  # debemos dividir por 100 para obtener las proporciones y no los porcentajes:
  frec_man_com_parcial <- filter(frec_man_com, frec_man_com$Var1 == i)
  frec_man_com_parcial$p <- frec_man_com_parcial$Freq*100/sum(frec_man_com_parcial$Freq)/100
  frec_man_com_parcial_total <- rbind(frec_man_com_parcial_total,frec_man_com_parcial)
}
```
<br>
Observemos los primeros 100 registros:

```{r}
r3_100 <- frec_man_com_parcial_total[c(1:100),]

kbl(r3_100) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```
<br>
Verifiquemos filtrando para la comuna 1107:

```{r}
frec_man_com_parcial_total_1107 <- filter(frec_man_com_parcial_total,frec_man_com_parcial_total$Var1 == 1107)
kbl(frec_man_com_parcial_total_1107) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```
<br>

Hay que agregar un cero a los códigos de 4 dígitos:

```{r}
# recogemos el campo Comuna:
codigos <- frec_man_com_parcial_total$Var1
# construimos una secuencia llamada rango del 1 al total de filas del dataset:
rango <- seq(1:nrow(frec_man_com_parcial_total))
# Creamos un string que agrega un cero a todos los registros:
cadena <- paste("0",codigos[rango], sep = "")

# El string cadena tiene o 5 o 6 digitos, los cuales siempre deben ser siempre 5 agregandole un cero al inicio de los que tienen 4.
# Para ello extraemos un substring de la cadena sobre todas las filas (rangos) comenzando desde el primero o el segundo y llegando siempre al 6.

cadena <- substr(cadena,(nchar(cadena)[rango])-(4),6)
codigos <- as.data.frame(codigos)
cadena <- as.data.frame(cadena)
comuna_corr <- cbind(frec_man_com_parcial_total,cadena)

```
<br>
Eliminamos columnas y renombramos:

```{r}
comuna_corr <- comuna_corr[,-c(1),drop=FALSE] 
names(comuna_corr)[4] <- "código" 
# comuna_corr
```

<br>
Veamos los 100 primeros registros:

```{r}
r3_100 <- comuna_corr[c(1:100),]

kbl(r3_100) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```

<br>

Leamos nuestra tabla que contiene integrados los ingresos expandidos y las frecuencias de hombres y mujeres por comuna


```{r}
h_y_m_2017_censo <- readRDS("h_y_m_2017_censo.rds")

r3_100 <- h_y_m_2017_censo[c(1:100),]

kbl(r3_100) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```
<br>
Hacemos la unión por código:

```{r}
h_y_m_comuna_corr = merge( x = comuna_corr, y = h_y_m_2017_censo, by = "código", all.x = TRUE)
```

```{r}
# 
r3_100 <- h_y_m_comuna_corr[c(1:100),]

kbl(r3_100) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```
<br>
Calculamos una nueva columna, que multiplica la frecuencia de hombres por comuna, la proporción a nivel de zona y los ingresos expandidos a nivel de comuna y divide por la cantidad de personas que viven en la comuna.

```{r}
h_y_m_comuna_corr$multi <- h_y_m_comuna_corr$Hombres*h_y_m_comuna_corr$p*h_y_m_comuna_corr$Ingresos_expandidos/h_y_m_comuna_corr$personas
```

```{r}
r3_100 <- h_y_m_comuna_corr[c(1:100),]

kbl(r3_100) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "300px")
```


<br>
<br>
<br>



## 3 Referencias

https://rpubs.com/osoramirez/316691

https://dataintelligencechile.shinyapps.io/casenfinal

Manual_de_usuario_Censo_2017_16R.pdf\

http://www.censo2017.cl/microdatos/


